#!/usr/bin/env bash

# Merge toutes les branches locales dans une branche cible (par d√©faut : main)
# Usage :
#   ./script_main_merging.sh          # merge tout dans main
#   ./script_main_merging.sh develop  # merge tout dans develop

set -u  # erreur si variable non d√©finie

TARGET_BRANCH="${1:-main}"

echo "üîç Target branch : ${TARGET_BRANCH}"
echo ""

# V√©rifie qu'on est bien dans un repo git
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  echo "‚ùå Ce r√©pertoire n'est pas un d√©p√¥t Git."
  exit 1
fi

# V√©rifie qu'il n'y a pas de changements non commit√©s
if ! git diff-index --quiet HEAD --; then
  echo "‚ùå Il y a des changements non commit√©s."
  echo "   Merci de commit ou stash avant de lancer le script."
  exit 1
fi

echo "‚¨áÔ∏è  Fetch des r√©f√©rences distantes..."
git fetch --all --prune
echo ""

echo "üì¶ Passage sur la branche cible : ${TARGET_BRANCH}"
if ! git checkout "${TARGET_BRANCH}"; then
  echo "‚ùå Impossible de se placer sur la branche ${TARGET_BRANCH}."
  exit 1
fi
echo ""

echo "üì• Mise √† jour de ${TARGET_BRANCH} depuis le remote (si pr√©sent)..."
if git rev-parse --verify "origin/${TARGET_BRANCH}" >/dev/null 2>&1; then
  if ! git pull --ff-only origin "${TARGET_BRANCH}"; then
    echo "‚ö†Ô∏è  Pull --ff-only impossible. V√©rifie l'√©tat de ${TARGET_BRANCH}."
    exit 1
  fi
else
  # Aucun remote pour cette branche, on ne fait rien de plus
  echo "‚ÑπÔ∏è Aucun remote 'origin/${TARGET_BRANCH}' trouv√©, skip du pull."
fi
echo ""

echo "üßæ R√©cup√©ration de la liste des branches locales (hors ${TARGET_BRANCH})..."
BRANCHES=$(git for-each-ref refs/heads --format='%(refname:short)' | grep -v "^${TARGET_BRANCH}$" || true)

if [ -z "${BRANCHES}" ]; then
  echo "‚ÑπÔ∏è Aucune autre branche locale √† merger."
  exit 0
fi

echo "üåø Branches √† merger dans ${TARGET_BRANCH} :"
echo "${BRANCHES}"
echo ""

FAILED_BRANCHES=()

for BR in ${BRANCHES}; do
  echo "================================"
  echo "üîÅ Merge de la branche : ${BR}"
  echo "================================"

  if git merge --no-ff "${BR}" -m "Merge branch '${BR}' into ${TARGET_BRANCH}"; then
    echo "‚úÖ Merge de ${BR} r√©ussi."
  else
    echo "‚ö†Ô∏è Conflits d√©tect√©s lors du merge de ${BR}."
    echo "   -> Annulation du merge et passage √† la branche suivante."
    git merge --abort || true
    FAILED_BRANCHES+=("${BR}")
  fi

  echo ""
done

echo "üì§ Push de ${TARGET_BRANCH} vers le d√©p√¥t distant (si 'origin' existe)..."
if git remote get-url origin >/dev/null 2>&1; then
  if git rev-parse --verify "origin/${TARGET_BRANCH}" >/dev/null 2>&1; then
    git push origin "${TARGET_BRANCH}" || echo "‚ö†Ô∏è Le push vers origin/${TARGET_BRANCH} a √©chou√©."
  else
    git push -u origin "${TARGET_BRANCH}" || echo "‚ö†Ô∏è Le push vers origin/${TARGET_BRANCH} a √©chou√©."
  fi
else
  echo "‚ÑπÔ∏è Aucun remote 'origin' configur√©, skip du push."
fi

echo ""
echo "üìä R√âCAPITULATIF"
echo "----------------"

if [ ${#FAILED_BRANCHES[@]} -eq 0 ]; then
  echo "üéâ Tous les merges se sont bien pass√©s."
else
  echo "‚ö†Ô∏è Les branches suivantes n'ont PAS √©t√© merg√©es √† cause de conflits :"
  for BR in "${FAILED_BRANCHES[@]}"; do
    echo "   - ${BR}"
  done
  echo ""
  echo "Tu peux les traiter manuellement, par exemple :"
  echo "  git checkout ${TARGET_BRANCH}"
  echo "  git merge <branche_en_conflit>"
fi

echo ""
echo "‚úÖ Script termin√©."
